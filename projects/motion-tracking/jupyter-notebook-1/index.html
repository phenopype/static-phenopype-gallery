<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../../../genindex/" /><link rel="search" title="Search" href="../../../search/" /><link rel="next" title="Sandbox" href="../../../sandbox/" /><link rel="prev" title="Motion tracking" href="../" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>Motion tracking - phenopype gallery</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/twemoji.css?v=2199c511" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=091b0f1f" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../"><div class="brand">phenopype gallery</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/phenopype_logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">phenopype gallery</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search/" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Internal links</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../instructions/">Instructions</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../">Projects</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Projects</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../../id-tags/">ID tags</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of ID tags</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../id-tags/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../qr-codes/">QR codes</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of QR codes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../qr-codes/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../stickleback-landmarks/">Stickleback landmarks</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Stickleback landmarks</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../stickleback-landmarks/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../phytoplankton-fluorescence/">Phytoplankton fluorescence and shape</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Phytoplankton fluorescence and shape</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../phytoplankton-fluorescence/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../isopod-counting/">Counting isopods</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Counting isopods</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../isopod-counting/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../snail-counting/">Counting snails</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Counting snails</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../snail-counting/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../cichlid-teeth/">Cichlid teeth</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Cichlid teeth</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cichlid-teeth/jupyter-notebook-1/">Jupyter notebook 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cichlid-teeth/jupyter-notebook-2/">Jupyter notebook 2</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../worm-length/">Worm length</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Worm length</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../worm-length/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../stickleback-plates/">Stickleback armor plates</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Stickleback armor plates</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../stickleback-plates/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../damselfly-phenomics/">Damselfly morphology</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Damselfly morphology</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../damselfly-phenomics/jupyter-notebook-1/">Jupyter notebook</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="../">Motion tracking</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Motion tracking</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Jupyter notebook</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../sandbox/">Sandbox</a></li>
</ul>

    <ul class="current">
		<p class="caption"><span class="caption-text">External links</span></p>		
		<li class="toctree-l1"><a class="reference external" href="https://www.phenopype.org">Homepage</a></li>
		<li class="toctree-l1"><a class="reference external" href="https://github.com/phenopype/phenopype">Github</a></li>
		<li class="toctree-l1"><a class="reference external" href="https://www.phenopype.org/docs/">Docs</a></li>
	</ul>
</div>

</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/phenopype/phenopype-gallery/edit/main/docs_source/projects/motion-tracking/jupyter-notebook-1.ipynb" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="motion-tracking">
<h1>Motion tracking<a class="headerlink" href="#motion-tracking" title="Link to this heading">#</a></h1>
<p>For a more detailed description see: <a class="reference external" href="https://www.phenopype.org/gallery/projects/motion-tracking/">https://www.phenopype.org/gallery/projects/motion-tracking/</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">phenopype</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">trackpy</span> <span class="k">as</span> <span class="nn">tp</span> <span class="c1">## install with `pip install trackpy`</span>

<span class="c1">## my root directory - modify as you see fit </span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;D:\science\packages\phenopype\phenopype-gallery_exec&quot;</span><span class="p">)</span>

<span class="c1">## my laptop has a small screen, so I use a smaller phenopype window</span>
<span class="n">pp</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">window_max_dim</span> <span class="o">=</span> <span class="mi">800</span>
</pre></div>
</div>
</div>
</div>
<section id="initialize-motion-tracker">
<h2>Initialize motion-tracker<a class="headerlink" href="#initialize-motion-tracker" title="Link to this heading">#</a></h2>
<p>Video analsyis in phenopype works a bit differently than images. Rather than making a project, videos are analyzed one by one. However. to batch process images, you can recycle some of the code. Here, I show how to analyze a single video though. First we initialize the motion tracker with our example video, and specify the video output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mt</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">motion_tracker</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;data_raw\motion-tracking\isopods_fish.mp4&quot;</span><span class="p">)</span>

<span class="n">mt</span><span class="o">.</span><span class="n">video_output</span><span class="p">(</span><span class="n">save_suffix</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;phenopype\motion-tracking&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we create a mask to only include the gravel area - this will exclude the walls where reflections and floating particles may result in false positives. A second mask in the center of the area can later be used to compare whether isopods tend to stay more on the side (shy behavior) or whether they move freely (bold behavior). In each captured frame there will be an entry for each isopods in which area it was detected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">masks</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">create_mask</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">annotation_id</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="n">masks</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">create_mask</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">masks</span><span class="p">,</span> <span class="n">annotation_id</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we set up two <code class="docutils literal notranslate"><span class="pre">tracking_methods</span></code>: the “fish” method is set to <code class="docutils literal notranslate"><span class="pre">&quot;single&quot;</span></code> and will only capture the largest object, whereas the isopod method will capture all objects smaller than 30 pixels. You can play around with <code class="docutils literal notranslate"><span class="pre">blur</span></code> and <code class="docutils literal notranslate"><span class="pre">threshold</span></code> settings to see if you can get better results. The <code class="docutils literal notranslate"><span class="pre">operations</span></code> argument is used to return specific information of the detected objects. We specify a few parameters to retrieve phenotypic information of the isopods. Later, we can then analyze which phenotypes were foraged on which sediment background.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fish</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">tracking_method</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;fish&quot;</span><span class="p">,</span> <span class="n">remove_shadows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                          <span class="n">overlay_colour</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span> 
                          <span class="n">blur</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="c1"># bigger blurring kernel</span>
                          <span class="n">threshold</span><span class="o">=</span><span class="mi">200</span> <span class="c1">#higher sensitivity</span>
                         <span class="p">)</span> 
<span class="n">isopod</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">tracking_method</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;isopod&quot;</span><span class="p">,</span> <span class="n">remove_shadows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                            <span class="n">overlay_colour</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;multiple&quot;</span><span class="p">,</span>
                            <span class="n">blur</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="c1"># smaller blurring kernel</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="c1"># lower sensitivity</span>
                            <span class="n">operations</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;diameter&quot;</span><span class="p">,</span>  <span class="c1"># isopod size</span>
                                        <span class="s2">&quot;area&quot;</span><span class="p">,</span>      <span class="c1"># isopod area</span>
                                        <span class="s2">&quot;grayscale&quot;</span><span class="p">,</span> <span class="c1"># isopod pigmentation </span>
                                        <span class="s2">&quot;grayscale_background&quot;</span><span class="p">]</span> <span class="c1"># background darkness</span>
                           <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we pass the methods on the detection settings, and also activate <em>consecutive masking</em> (<code class="docutils literal notranslate"><span class="pre">c_mask=True</span></code>). This option will prohibit repeated detection of objects when several tracking methods are applied. For example, inside the detected fish-area sometimes isopod objects are detected, due to artifacts or incomplete subtraction results. Consecutive masking will “block” an area after the first method has been applied - the order by which methods are applied matters. The following settings will create a rectangle shaped mask around the fish with a 200 pixel border.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mt</span><span class="o">.</span><span class="n">detection_settings</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="n">fish</span><span class="p">,</span> <span class="n">isopod</span><span class="p">],</span>
                     <span class="n">c_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">c_mask_shape</span><span class="o">=</span><span class="s2">&quot;rect&quot;</span><span class="p">,</span>
                     <span class="n">c_mask_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                     <span class="n">masks</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">run_tracking</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the objects outside the masks were still detected and drawn onto the overlay. If you do not want to include them in the trajectory analysis, or your analysis, simply filter those rows out (i.e., the rows where all masks return <code class="docutils literal notranslate"><span class="pre">False</span></code>).</p>
<p>After completing the tracking, we end up with a big data frame of all contours</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coordinates</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">mt</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;coordinates.csv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="n">coordinates</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="analyzing-tracking-results-with-trackpy">
<h2>Analyzing tracking results with <em>trackpy</em><a class="headerlink" href="#analyzing-tracking-results-with-trackpy" title="Link to this heading">#</a></h2>
<p>Now we can use the frame-wise coordinates to construct trajectories of isopods and fish. For this we will use the excellent <em>trackpy</em> library (<a class="reference external" href="https://soft-matter.github.io/trackpy">https://soft-matter.github.io/trackpy</a>). Trackpy is a Python package for particle tracking in 2D, 3D, and higher dimensions.</p>
<p>Here you need to find out what works best for your specific case - the larger search_range or memory are, the more challenging it is for the algorithm to find a solution, especially if you have many moving objects in your video. With only one, it should be ok to go to high values. The filtering step is optional, but can be useful to eliminate spurious trajectories.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## matplotlib requires rgb format, but opencv/phenopype use bgr. we need to convert our static background image</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">mt</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## fish trajectories</span>
<span class="n">fish_df</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">coordinates</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fish&quot;</span> <span class="p">]</span> <span class="c1"># just use the fish-coordinates</span>
<span class="n">traj_fish</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">link_df</span><span class="p">(</span><span class="n">fish_df</span><span class="p">,</span> 
                       <span class="n">search_range</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="c1">#how for to look for the fish in the next frame. can be large if fish swims fast</span>
                       <span class="n">memory</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="c1"># how long can the fish sit still</span>
                       <span class="n">neighbor_strategy</span><span class="o">=</span><span class="s2">&quot;KDTree&quot;</span><span class="p">,</span> 
                       <span class="n">link_strategy</span><span class="o">=</span><span class="s2">&quot;nonrecursive&quot;</span><span class="p">)</span>
<span class="n">traj_fish_filter</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">filtering</span><span class="o">.</span><span class="n">filter_stubs</span><span class="p">(</span><span class="n">traj_fish</span><span class="p">,</span> 
                                             <span class="n">threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="c1"># filter out particles that were only found 20 times</span>

<span class="c1">## plot </span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">plot_traj</span><span class="p">(</span><span class="n">traj_fish_filter</span><span class="p">,</span> 
                    <span class="n">superimpose</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<span class="n">fig1</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">mt</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_fish_trajectories.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For isopods, we perform one additional step: because we know that we have 20 isopds, we remove frames with more particles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## isopod trajectories</span>
<span class="n">df_isopod</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">coordinates</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;isopod&quot;</span> <span class="p">]</span> <span class="c1"># just use the isopod-coordinates</span>
<span class="n">df_isopod_filtered</span> <span class="o">=</span> <span class="n">df_isopod</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># filter out frames with too many points</span>
<span class="n">traj_isopod</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">df_isopod_filtered</span><span class="p">,</span> 
                      <span class="n">search_range</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="c1"># isopods are slow, so this can be small. especially important when using &quot;multiple&quot;</span>
                      <span class="n">memory</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="c1"># isopods can sit still longer</span>
                      <span class="n">neighbor_strategy</span><span class="o">=</span><span class="s2">&quot;KDTree&quot;</span><span class="p">,</span> 
                      <span class="n">link_strategy</span><span class="o">=</span><span class="s2">&quot;nonrecursive&quot;</span><span class="p">)</span>
<span class="n">traj_isopod_filter</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">filtering</span><span class="o">.</span><span class="n">filter_stubs</span><span class="p">(</span><span class="n">traj_isopod</span><span class="p">,</span> 
                                               <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># each particle needs to be found at least 10 times </span>

<span class="c1">##p lot</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">plot_traj</span><span class="p">(</span><span class="n">traj_isopod_filter</span><span class="p">,</span> <span class="n">superimpose</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">colorby</span><span class="o">=</span><span class="s2">&quot;particle&quot;</span><span class="p">)</span>
<span class="n">fig1</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">mt</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_isopod_trajectories.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally we save all trajectories into one DataFrame and export them into to the specified directory, so you can do fine tuning in your favorite data analysis program (e.g. R or in Python with Pandas).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save all</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">traj_isopod_filter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">traj_fish_filter</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">mt</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_trajectories.csv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../../sandbox/">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Sandbox</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Motion tracking</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Moritz Lürig
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on 2024-02-21 15:17:47</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Motion tracking</a><ul>
<li><a class="reference internal" href="#initialize-motion-tracker">Initialize motion-tracker</a></li>
<li><a class="reference internal" href="#analyzing-tracking-results-with-trackpy">Analyzing tracking results with <em>trackpy</em></a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=187304be"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js"></script>
    <script src="../../../_static/twemoji.js?v=a4381b3f"></script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script src="https://cdn.jsdelivr.net/gh/mluerig/website-assets/assets/js/enforce_trailing_slash.min.js"></script>
    </body>
</html>